<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Levantamentos Topográficos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container my-5">
        <h1 class="text-center mb-4">Gerador de Levantamentos Topográficos</h1>

        <!-- Mensagens -->
        {% if messages %}
            <div class="alert alert-dismissible fade show" role="alert">
                {% for message in messages %}
                    <div class="{% if message.tags %}alert-{{ message.tags }}{% endif %}">{{ message }}</div>
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <!-- Formulário para Selecionar ou Adicionar Projeto -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Selecionar ou Adicionar Projeto</h2>
            </div>
            <div class="card-body">
                <!-- Formulário para Selecionar Projeto -->
                <h3 class="h6 mb-3">Selecionar Projeto Existente</h3>
                <form method="POST" class="mb-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="selecionar_projeto">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="projeto_filtro" class="form-label">Projeto</label>
                            <select class="form-select" id="projeto_filtro" name="projeto_filtro" onchange="this.form.submit()">
                                <option value="" disabled {% if not projeto_selecionado %}selected{% endif %}>Selecione um projeto</option>
                                {% for projeto in projetos %}
                                    <option value="{{ projeto.id }}" {% if projeto_selecionado.id == projeto.id %}selected{% endif %}>{{ projeto.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>

                <!-- Formulário para Adicionar Novo Projeto -->
                <h3 class="h6 mb-3">Adicionar Novo Projeto</h3>
                <form method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_projeto">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nome_projeto" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="nome_projeto" name="nome_projeto" placeholder="Ex.: Fazenda Boa Vista" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Inscrição Imobiliária</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                name="inscricao_imobiliaria"
                                placeholder="Ex: 01.02.003.0456.000"
                            >
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endereco_projeto" class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="endereco_projeto" name="endereco_projeto" placeholder="Ex.: Rua Principal, s/n" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="area_projeto" class="form-label">Área (m²)</label>
                            <input type="number" step="0.01" class="form-control" id="area_projeto" name="area_projeto" placeholder="Ex.: 1000.50" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="perimetro_projeto" class="form-label">Perímetro (m)</label>
                            <input type="number" step="0.01" class="form-control" id="perimetro_projeto" name="perimetro_projeto" placeholder="Ex.: 150.75" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="epoca_medicao" class="form-label">Época da Medição</label>
                            <input type="text" class="form-control" id="epoca_medicao" name="epoca_medicao" placeholder="Ex.: Março de 2025" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="instrumento" class="form-label">Instrumento Utilizado</label>
                            <input type="text" class="form-control" id="instrumento" name="instrumento" placeholder="Ex.: GNSS Com Nav T30" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Adicionar Projeto</button>
                </form>
            </div>
        </div>

        <!-- Exibir Informações do Projeto Selecionado -->
        {% if projeto_selecionado %}
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Informações do Projeto: {{ projeto_selecionado.nome }}</h2>
                </div>
                <div class="card-body">
                    <p><strong>Nome:</strong> {{ projeto_selecionado.nome }}</p>
                    <p><strong>Inscrição Imobiliária:</strong> {{ projeto_selecionado.inscricao_imobiliaria }}</p>
                    <p><strong>Endereço:</strong> {{ projeto_selecionado.endereco }}</p>
                    <p><strong>Área:</strong> {{ projeto_selecionado.area }} m²</p>
                    <p><strong>Perímetro:</strong> {{ projeto_selecionado.perimetro }} m</p>
                    <p><strong>Época da Medição:</strong> {{ projeto_selecionado.epoca_medicao }}</p>
                    <p><strong>Instrumento Utilizado:</strong> {{ projeto_selecionado.instrumento }}</p>
                </div>
            </div>

            <!-- Gerenciar Beneficiários -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Beneficiários do Projeto</h2>
                    <div>
                        <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addBeneficiarioModal">Adicionar Beneficiário</button>
                        <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importBeneficiariosModal">Importar Beneficiários</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if beneficiarios %}
                        <ul class="list-group">
                            {% for ben in beneficiarios %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ ben.nome }} ({{ ben.cpf_cnpj }}) - 
                                    {{ ben.rua }}, {{ ben.numero }}, {{ ben.bairro }}, {{ ben.cidade }}
                                    <div>
                                        <button type="button" class="btn btn-sm btn-warning me-2" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editBeneficiarioModal" 
                                                data-id="{{ ben.id }}" 
                                                data-nome="{{ ben.nome }}" 
                                                data-cpf_cnpj="{{ ben.cpf_cnpj }}" 
                                                data-rua="{{ ben.rua }}" 
                                                data-numero="{{ ben.numero }}" 
                                                data-bairro="{{ ben.bairro }}" 
                                                data-cidade="{{ ben.cidade }}">Editar</button>
                                        <form method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este beneficiário?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete_beneficiario">
                                            <input type="hidden" name="beneficiario_id" value="{{ ben.id }}">
                                            <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                                        </form>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-info">Nenhum beneficiário cadastrado para este projeto.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Modal para Adicionar Beneficiário -->
            <div class="modal fade" id="addBeneficiarioModal" tabindex="-1" aria-labelledby="addBeneficiarioModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addBeneficiarioModalLabel">Adicionar Beneficiário</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="add_beneficiario">
                                <input type="hidden" name="projeto_ben" value="{{ projeto_selecionado.id }}">
                                <div class="mb-3">
                                    <label for="nome_ben" class="form-label">Nome</label>
                                    <input type="text" class="form-control" id="nome_ben" name="nome_ben" placeholder="Ex.: João Silva" required>
                                </div>
                                <div class="mb-3">
                                    <label for="cpf_cnpj_ben" class="form-label">CPF ou CNPJ</label>
                                    <input type="text" class="form-control cpf-cnpj" id="cpf_cnpj_ben" name="cpf_cnpj_ben" placeholder="Ex.: 123.456.789-00 ou 12.345.678/0001-99" required>
                                </div>
                                <div class="mb-3">
                                    <label for="rua_ben" class="form-label">Rua</label>
                                    <input type="text" class="form-control" id="rua_ben" name="rua_ben" placeholder="Ex.: Rua do Sol" required>
                                </div>
                                <div class="mb-3">
                                    <label for="numero_ben" class="form-label">Número</label>
                                    <input type="text" class="form-control" id="numero_ben" name="numero_ben" placeholder="Ex.: 123" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bairro_ben" class="form-label">Bairro</label>
                                    <input type="text" class="form-control" id="bairro_ben" name="bairro_ben" placeholder="Ex.: Centro" required>
                                </div>
                                <div class="mb-3">
                                    <label for="cidade_ben" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="cidade_ben" name="cidade_ben" placeholder="Ex.: Florianópolis" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Adicionar Beneficiário</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Editar Beneficiário -->
            <div class="modal fade" id="editBeneficiarioModal" tabindex="-1" aria-labelledby="editBeneficiarioModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editBeneficiarioModalLabel">Editar Beneficiário</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_beneficiario">
                                <input type="hidden" name="beneficiario_id" id="edit_beneficiario_id">
                                <div class="mb-3">
                                    <label for="edit_nome_ben" class="form-label">Nome</label>
                                    <input type="text" class="form-control" id="edit_nome_ben" name="nome_ben" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_cpf_cnpj_ben" class="form-label">CPF ou CNPJ</label>
                                    <input type="text" class="form-control cpf-cnpj" id="edit_cpf_cnpj_ben" name="cpf_cnpj_ben" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_rua_ben" class="form-label">Rua</label>
                                    <input type="text" class="form-control" id="edit_rua_ben" name="rua_ben" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_numero_ben" class="form-label">Número</label>
                                    <input type="text" class="form-control" id="edit_numero_ben" name="numero_ben" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_bairro_ben" class="form-label">Bairro</label>
                                    <input type="text" class="form-control" id="edit_bairro_ben" name="bairro_ben" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_cidade_ben" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="edit_cidade_ben" name="cidade_ben" required>
                                </div>
                                <button type="submit" class="btn btn-success">Salvar Alterações</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Importar Beneficiários -->
            <div class="modal fade" id="importBeneficiariosModal" tabindex="-1" aria-labelledby="importBeneficiariosModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="importBeneficiariosModalLabel">Importar Beneficiários (Arquivo TXT)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="importar_beneficiarios">
                                <input type="hidden" name="projeto_ben" value="{{ projeto_selecionado.id }}">
                                <div class="mb-3">
                                    <label for="arquivo_beneficiarios" class="form-label">Arquivo TXT</label>
                                    <input type="file" class="form-control" id="arquivo_beneficiarios" name="arquivo_beneficiarios" accept=".txt" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Importar Beneficiários</button>
                            </form>
                            <p class="mt-3">Formato do TXT: Cada linha deve conter: Nome, CPF/CNPJ, Rua, Número, Bairro, Cidade, separados por tabulação.</p>
                            <p>Exemplo:</p>
                            <pre>
João Silva    123.456.789-00    Rua do Sol    123    Centro    Florianópolis
Ana Pereira    987.654.321-00    Rua da Lua    456    Jurerê    Florianópolis
                            </pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gerenciar Confrontantes -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Confrontantes do Projeto</h2>
                    <div>
                        <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addConfrontanteModal">Adicionar Confrontante</button>
                        <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importConfrontantesModal">Importar Confrontantes</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if confrontantes %}
                        <form id="confrontantes-form" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="toggle_confrontante_pdf">
                            <ul class="list-group">
                                {% for con in confrontantes %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <input type="checkbox" name="excluir_confrontantes" value="{{ con.id }}"
                                                {% if con.excluir_do_pdf %}checked{% endif %}
                                                onchange="document.getElementById('confrontantes-form').submit()">
                                            <span class="ms-2">
                                                {{ con.nome }} ({{ con.cpf_cnpj }}) - {{ con.direcao }} - 
                                                {{ con.rua }}, {{ con.numero }}, {{ con.bairro }}, {{ con.cidade }}
                                            </span>
                                        </div>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-warning me-2" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editConfrontanteModal" 
                                                    data-id="{{ con.id }}" 
                                                    data-nome="{{ con.nome }}" 
                                                    data-cpf_cnpj="{{ con.cpf_cnpj }}" 
                                                    data-direcao="{{ con.direcao }}" 
                                                    data-rua="{{ con.rua }}" 
                                                    data-numero="{{ con.numero }}" 
                                                    data-bairro="{{ con.bairro }}" 
                                                    data-cidade="{{ con.cidade }}">Editar</button>
                                            <form method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este confrontante?');">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="delete_confrontante">
                                                <input type="hidden" name="confrontante_id" value="{{ con.id }}">
                                                <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                                            </form>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </form>
                    {% else %}
                        <div class="alert alert-info">Nenhum confrontante cadastrado para este projeto.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Modal para Adicionar Confrontante -->
            <div class="modal fade" id="addConfrontanteModal" tabindex="-1" aria-labelledby="addConfrontanteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addConfrontanteModalLabel">Adicionar Confrontante</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="add_confrontante">
                                <input type="hidden" name="projeto_con" value="{{ projeto_selecionado.id }}">
                                <div class="mb-3">
                                    <label for="nome_con" class="form-label">Nome</label>
                                    <input type="text" class="form-control" id="nome_con" name="nome_con" placeholder="Ex.: Vilmar Ferreira Fontes" required>
                                </div>
                                <div class="mb-3">
                                    <label for="cpf_cnpj_con" class="form-label">CPF ou CNPJ</label>
                                    <input type="text" class="form-control cpf-cnpj" id="cpf_cnpj_con" name="cpf_cnpj_con" placeholder="Ex.: 123.456.789-00 ou 12.345.678/0001-99" required>
                                </div>
                                <div class="mb-3">
                                    <label for="direcao_con" class="form-label">Direção</label>
                                    <select class="form-select" id="direcao_con" name="direcao_con" required>
                                        <option value="" disabled selected>Selecione a direção</option>
                                        <option value="Frente">Frente</option>
                                        <option value="Fundos">Fundos</option>
                                        <option value="Direito">Direito</option>
                                        <option value="Esquerdo">Esquerdo</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="rua_con" class="form-label">Rua</label>
                                    <input type="text" class="form-control" id="rua_con" name="rua_con" placeholder="Ex.: Rua do Mar" required>
                                </div>
                                <div class="mb-3">
                                    <label for="numero_con" class="form-label">Número</label>
                                    <input type="text" class="form-control" id="numero_con" name="numero_con" placeholder="Ex.: 789" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bairro_con" class="form-label">Bairro</label>
                                    <input type="text" class="form-control" id="bairro_con" name="bairro_con" placeholder="Ex.: Jurerê" required>
                                </div>
                                <div class="mb-3">
                                    <label for="cidade_con" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="cidade_con" name="cidade_con" placeholder="Ex.: Florianópolis" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Adicionar Confrontante</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Editar Confrontante -->
            <div class="modal fade" id="editConfrontanteModal" tabindex="-1" aria-labelledby="editConfrontanteModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editConfrontanteModalLabel">Editar Confrontante</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_confrontante">
                                <input type="hidden" name="confrontante_id" id="edit_confrontante_id">
                                <div class="mb-3">
                                    <label for="edit_nome_con" class="form-label">Nome</label>
                                    <input type="text" class="form-control" id="edit_nome_con" name="nome_con" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_cpf_cnpj_con" class="form-label">CPF ou CNPJ</label>
                                    <input type="text" class="form-control cpf-cnpj" id="edit_cpf_cnpj_con" name="cpf_cnpj_con" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_direcao_con" class="form-label">Direção</label>
                                    <select class="form-select" id="edit_direcao_con" name="direcao_con" required>
                                        <option value="" disabled>Selecione a direção</option>
                                        <option value="Frente">Frente</option>
                                        <option value="Fundos">Fundos</option>
                                        <option value="Direito">Direito</option>
                                        <option value="Esquerdo">Esquerdo</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_rua_con" class="form-label">Rua</label>
                                    <input type="text" class="form-control" id="edit_rua_con" name="rua_con" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_numero_con" class="form-label">Número</label>
                                    <input type="text" class="form-control" id="edit_numero_con" name="numero_con" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_bairro_con" class="form-label">Bairro</label>
                                    <input type="text" class="form-control" id="edit_bairro_con" name="bairro_con" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_cidade_con" class="form-label">Cidade</label>
                                    <input type="text" class="form-control" id="edit_cidade_con" name="cidade_con" required>
                                </div>
                                <button type="submit" class="btn btn-success">Salvar Alterações</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Importar Confrontantes -->
            <div class="modal fade" id="importConfrontantesModal" tabindex="-1" aria-labelledby="importConfrontantesModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="importConfrontantesModalLabel">Importar Confrontantes (Arquivo TXT)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="importar_confrontantes">
                                <input type="hidden" name="projeto_con" value="{{ projeto_selecionado.id }}">
                                <div class="mb-3">
                                    <label for="arquivo_confrontantes" class="form-label">Arquivo TXT</label>
                                    <input type="file" class="form-control" id="arquivo_confrontantes" name="arquivo_confrontantes" accept=".txt" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Importar Confrontantes</button>
                            </form>
                            <p class="mt-3">Formato do TXT: Cada linha deve conter: Nome, CPF/CNPJ, Direção (Frente, Fundos, Direito ou Esquerdo), Rua, Número, Bairro, Cidade, separados por tabulação.</p>
                            <p>Exemplo:</p>
                            <pre>
Vilmar Ferreira Fontes    007.573.929-11    Norte    Rua do Mar    789    Jurerê    Florianópolis
Maria Oliveira    123.456.789-00    Sul    Rua do Sol    456    Centro    Florianópolis
                            </pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gerenciar Vértices -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Vértices do Projeto</h2>
                    <div>
                        <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addVerticeModal">Adicionar Vértice</button>
                        <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importVerticesModal">Importar Vértices</button>
                    </div>
                </div>
                <div class="card-body">
                    {% if vertices %}
                        <ul class="list-group">
                            {% for ver in vertices %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ ver.de_vertice }} -> {{ ver.para_vertice }} : 
                                    {{ ver.longitude }} | {{ ver.latitude }} | {{ ver.utm_n|floatformat:3 }} | {{ ver.utm_e|floatformat:3 }} | {{ ver.distancia }}m |  
                                    {% if ver.confrontante %}
                                        {{ ver.confrontante.nome }} ({{ ver.confrontante.cpf_cnpj }})
                                    {% else %}
                                        {{ ver.confrontante_texto|default:"Nenhum" }}
                                    {% endif %}
                                    <div>
                                        <button type="button" class="btn btn-sm btn-warning me-2" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editVerticeModal" 
                                                data-id="{{ ver.id }}" 
                                                data-de_vertice="{{ ver.de_vertice }}" 
                                                data-para_vertice="{{ ver.para_vertice }}" 
                                                data-longitude="{{ ver.longitude }}" 
                                                data-latitude="{{ ver.latitude }}" 
                                                data-distancia="{{ ver.distancia|floatformat:2|default:'0.00' }}"
                                                data-utmn="{{ ver.utm_n }}"
                                                data-utme="{{ ver.utm_e }}"
                                                data-confrontante_id="{% if ver.confrontante %}{{ ver.confrontante.id }}{% endif %}" 
                                                data-confrontante_texto="{{ ver.confrontante_texto|default_if_none:'' }}">Editar</button>
                                        <form method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este vértice?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="delete_vertice">
                                            <input type="hidden" name="vertice_id" value="{{ ver.id }}">
                                            <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                                        </form>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-info">Nenhum vértice cadastrado para este projeto.</div>
                    {% endif %}
                </div>
            </div>

            <!-- Modal para Adicionar Vértice -->
            <div class="modal fade" id="addVerticeModal" tabindex="-1" aria-labelledby="addVerticeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addVerticeModalLabel">Adicionar Vértice</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="add_vertice">
                                <input type="hidden" name="projeto_ver" value="{{ projeto_selecionado.id }}">
                                <div class="mb-3">
                                    <label for="de_vertice" class="form-label">De Vértice</label>
                                    <input type="text" class="form-control" id="de_vertice" name="de_vertice" placeholder="Ex.: V01" required>
                                </div>
                                <div class="mb-3">
                                    <label for="para_vertice" class="form-label">Para Vértice</label>
                                    <input type="text" class="form-control" id="para_vertice" name="para_vertice" placeholder="Ex.: V02" required>
                                </div>
                                <div class="mb-3">
                                    <label for="longitude_ver" class="form-label">Longitude</label>
                                    <input type="text" class="form-control coord-mask" id="longitude_ver" name="longitude_ver" placeholder="Ex.: 48°29'05.593" O" required>
                                </div>
                                <div class="mb-3">
                                    <label for="latitude_ver" class="form-label">Latitude</label>
                                    <input type="text" class="form-control coord-mask" id="latitude_ver" name="latitude_ver" placeholder="Ex.: 27°27'16.418" S" required>
                                </div>
                                <!-- Adicionar -->
                                <div class="mb-3">
                                    <label for="distancia_ver" class="form-label">Distância (m)</label>
                                    <input type="text" class="form-control" id="distancia_ver" name="distancia_ver" placeholder="Ex.: 3.22" required>
                                </div>
                                <div class="mb-3">
                                    <label for="utm_n_ver" class="form-label">N (UTM)</label>
                                    <input type="text" class="form-control utm-norte" id="utm_n_ver" name="utm_n_ver" placeholder="Ex: 6956911,591">
                                </div>

                                <div class="mb-3">
                                    <label for="utm_e_ver" class="form-label">E (UTM)</label>
                                    <input type="text" class="form-control utm-este" id="utm_e_ver" name="utm_e_ver" placeholder="Ex: 755924,028">
                                </div>

                                <div class="mb-3">
                                    <label for="confrontante_ver" class="form-label">Confrontante</label>
                                    <select class="form-select" id="confrontante_ver" name="confrontante_ver">
                                        <option value="">Nenhum (ex.: Rua, APP)</option>
                                        {% for confrontante in confrontantes %}
                                            <option value="{{ confrontante.id }}">{{ confrontante.nome }} ({{ confrontante.cpf_cnpj }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="confrontante_texto" class="form-label">Nome do Confrontante (se não selecionado)</label>
                                    <input type="text" class="form-control" id="confrontante_texto" name="confrontante_texto" placeholder="Ex.: Rua do Lamim, APP">
                                </div>
                                <button type="submit" class="btn btn-primary">Adicionar Vértice</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Editar Vértice -->
            <div class="modal fade" id="editVerticeModal" tabindex="-1" aria-labelledby="editVerticeModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editVerticeModalLabel">Editar Vértice</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="edit_vertice">
                                <input type="hidden" name="vertice_id" id="edit_vertice_id">
                                <div class="mb-3">
                                    <label for="edit_de_vertice" class="form-label">De Vértice</label>
                                    <input type="text" class="form-control" id="edit_de_vertice" name="de_vertice" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_para_vertice" class="form-label">Para Vértice</label>
                                    <input type="text" class="form-control" id="edit_para_vertice" name="para_vertice" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_longitude_ver" class="form-label">Longitude</label>
                                    <input type="text" class="form-control coord-mask" id="edit_longitude_ver" name="longitude_ver" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_latitude_ver" class="form-label">Latitude</label>
                                    <input type="text" class="form-control coord-mask" id="edit_latitude_ver" name="latitude_ver" required>
                                </div>
                                <!-- Editar -->
                                <div class="mb-3">
                                    <label for="edit_distancia_ver" class="form-label">Distância (m)</label>
                                    <input type="text" class="form-control" id="edit_distancia_ver" name="distancia_ver" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_utm_n_ver" class="form-label">N (UTM)</label>
                                    <input type="text" class="form-control utm-norte" id="edit_utm_n_ver" name="utm_n_ver">
                                </div>

                                <div class="mb-3">
                                    <label for="edit_utm_e_ver" class="form-label">E (UTM)</label>
                                    <input type="text" class="form-control utm-este" id="edit_utm_e_ver" name="utm_e_ver">
                                </div>

                                <div class="mb-3">
                                    <label for="edit_confrontante_ver" class="form-label">Confrontante</label>
                                    <select class="form-select" id="edit_confrontante_ver" name="confrontante_ver">
                                        <option value="">Nenhum (ex.: Rua, APP)</option>
                                        {% for confrontante in confrontantes %}
                                            <option value="{{ confrontante.id }}">{{ confrontante.nome }} ({{ confrontante.cpf_cnpj }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit_confrontante_texto" class="form-label">Nome do Confrontante (se não selecionado)</label>
                                    <input type="text" class="form-control" id="edit_confrontante_texto" name="confrontante_texto">
                                </div>
                                <button type="submit" class="btn btn-success">Salvar Alterações</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal para Importar Vértices -->
            <div class="modal fade" id="importVerticesModal" tabindex="-1" aria-labelledby="importVerticesModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="importVerticesModalLabel">Importar Vértices (Arquivo TXT)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="importar_vertices">
                                <input type="hidden" name="projeto_ver" value="{{ projeto_selecionado.id }}">
                                <div class="mb-3">
                                    <label for="arquivo_vertices" class="form-label">Arquivo TXT</label>
                                    <input type="file" class="form-control" id="arquivo_vertices" name="arquivo_vertices" accept=".txt" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Importar Vértices</button>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importUtmModal">Importar UTM</button>

                            </form>
                            <p class="mt-3">Formato do TXT: Cada linha deve conter: De Vértice, Para Vértice, Longitude, Latitude, Distância, Nome do Confrontante, CPF/CNPJ do Confrontante (opcional), separados por tabulação.</p>
                            <p>Exemplo:</p>
                            <pre>
V01    V02    48°29'05.593" O    27°27'16.418" S    3.22    Rua do Lamim    
V02    V03    48°29'05.653" O    27°27'16.328" S    17.09    Vilmar Ferreira Fontes    007.573.929-11
                            </pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="importUtmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Importar Coordenadas UTM (Somente Completar)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="importar_utm">
                                <input type="hidden" name="projeto_ver" value="{{ projeto_selecionado.id }}">

                                <div class="mb-3">
                                    <label class="form-label">Arquivo TXT (UTM)</label>
                                    <input type="file" class="form-control" name="arquivo_utm" accept=".txt" required>
                                </div>

                                <button type="submit" class="btn btn-success">Importar UTM</button>
                            </form>

                            <hr>

                            <p><strong>Formato do arquivo:</strong></p>
                            <pre>
V01, 6956911.591, 755924.028
V02, 6956911.607, 755916.946
V03, 6956938.278, 755917.617
V04, 6956938.013, 755924.694
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
  


            <!-- Botão para Gerar Memorial -->
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h5 mb-0">Gerar Memorial Descritivo</h2>
                </div>
                <div class="card-body">
                    <form method="POST" class="d-inline-block">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="gerar_memorial">
                        <input type="hidden" name="projeto_memorial" value="{{ projeto_selecionado.id }}">
                        <button type="submit" class="btn btn-success">Gerar e Baixar Memorial</button>
                    </form>
                    <!-- Novo botão para gerar o PDF -->
                    <form method="POST" class="d-inline-block ms-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="gerar_memorial_pdf">
                        <input type="hidden" name="projeto_memorial" value="{{ projeto_selecionado.id }}">
                        <button type="submit" class="btn btn-primary">Gerar Memorial (PDF)</button>
                    </form>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Bootstrap JS e Inputmask -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {

        /* ================= CPF / CNPJ ================= */
        Inputmask({
            mask: ['999.999.999-99', '99.999.999/9999-99'],
            keepStatic: true,
            placeholder: " "
        }).mask(document.querySelectorAll('.cpf-cnpj'));

        /* ================= UTM NORTE ================= */
        Inputmask({
            alias: "numeric",
            groupSeparator: ".",
            radixPoint: ",",
            digits: 3,
            digitsOptional: false,
            autoGroup: true,
            rightAlign: false,
            allowMinus: false
        }).mask(document.querySelectorAll('.utm-norte'));

        /* ================= UTM ESTE ================= */
        Inputmask({
            alias: "numeric",
            groupSeparator: ".",
            radixPoint: ",",
            digits: 3,
            digitsOptional: false,
            autoGroup: true,
            rightAlign: false,
            allowMinus: false
        }).mask(document.querySelectorAll('.utm-este'));

        /* ================= DISTÂNCIA ================= */
        Inputmask({
            alias: "numeric",
            groupSeparator: ".",
            radixPoint: ",",
            digits: 2,
            digitsOptional: false,
            autoGroup: true,
            rightAlign: false,
            allowMinus: false
        }).mask(document.querySelectorAll('#distancia_ver, #edit_distancia_ver'));

            
            // Preencher o modal de edição de beneficiário
            const editBeneficiarioModal = document.getElementById('editBeneficiarioModal');
            editBeneficiarioModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const nome = button.getAttribute('data-nome');
                const cpf_cnpj = button.getAttribute('data-cpf_cnpj');
                const rua = button.getAttribute('data-rua');
                const numero = button.getAttribute('data-numero');
                const bairro = button.getAttribute('data-bairro');
                const cidade = button.getAttribute('data-cidade');

                const modal = this;
                modal.querySelector('#edit_beneficiario_id').value = id;
                modal.querySelector('#edit_nome_ben').value = nome;
                modal.querySelector('#edit_cpf_cnpj_ben').value = cpf_cnpj;
                modal.querySelector('#edit_rua_ben').value = rua;
                modal.querySelector('#edit_numero_ben').value = numero;
                modal.querySelector('#edit_bairro_ben').value = bairro;
                modal.querySelector('#edit_cidade_ben').value = cidade;
            });

            // Preencher o modal de edição de confrontante
            const editConfrontanteModal = document.getElementById('editConfrontanteModal');
            editConfrontanteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const nome = button.getAttribute('data-nome');
                const cpf_cnpj = button.getAttribute('data-cpf_cnpj');
                const direcao = button.getAttribute('data-direcao');
                const rua = button.getAttribute('data-rua');
                const numero = button.getAttribute('data-numero');
                const bairro = button.getAttribute('data-bairro');
                const cidade = button.getAttribute('data-cidade');

                const modal = this;
                modal.querySelector('#edit_confrontante_id').value = id;
                modal.querySelector('#edit_nome_con').value = nome;
                modal.querySelector('#edit_cpf_cnpj_con').value = cpf_cnpj;
                modal.querySelector('#edit_direcao_con').value = direcao;
                modal.querySelector('#edit_rua_con').value = rua;
                modal.querySelector('#edit_numero_con').value = numero;
                modal.querySelector('#edit_bairro_con').value = bairro;
                modal.querySelector('#edit_cidade_con').value = cidade;
            });

            // Preencher o modal de edição de vértice
            const editVerticeModal = document.getElementById('editVerticeModal');
            editVerticeModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const de_vertice = button.getAttribute('data-de_vertice');
                const para_vertice = button.getAttribute('data-para_vertice');
                const longitude = button.getAttribute('data-longitude');
                const latitude = button.getAttribute('data-latitude');
                const distancia = button.getAttribute('data-distancia');
                const utm_n = button.getAttribute('data-utmn');
                const utm_e = button.getAttribute('data-utme');
                const confrontante_id = button.getAttribute('data-confrontante_id');
                const confrontante_texto = button.getAttribute('data-confrontante_texto');

                const modal = this;
                modal.querySelector('#edit_vertice_id').value = id;
                modal.querySelector('#edit_de_vertice').value = de_vertice;
                modal.querySelector('#edit_para_vertice').value = para_vertice;
                modal.querySelector('#edit_longitude_ver').value = longitude;
                modal.querySelector('#edit_latitude_ver').value = latitude;
                modal.querySelector('#edit_distancia_ver').value = distancia;
                if (utm_n) {
                    modal.querySelector('#edit_utm_n_ver').value =
                        parseFloat(utm_n).toLocaleString('pt-BR', {
                            minimumFractionDigits: 3,
                            maximumFractionDigits: 3
                        });
                }

                if (utm_e) {
                    modal.querySelector('#edit_utm_e_ver').value =
                        parseFloat(utm_e).toLocaleString('pt-BR', {
                            minimumFractionDigits: 3,
                            maximumFractionDigits: 3
                        });
                }
                modal.querySelector('#edit_confrontante_ver').value = confrontante_id || '';
                modal.querySelector('#edit_confrontante_texto').value = confrontante_texto;
            });
        });
    </script>


    <script>
    document.addEventListener("DOMContentLoaded", function () {

        function aplicarMascaraCoordenada(input) {

            input.addEventListener("input", function () {
                let v = input.value.toUpperCase();

                // Remove tudo que não for número ou letra
                v = v.replace(/[^0-9NSO]/g, "");

                // Detecta hemisfério
                let hemisferio = "";
                if (v.endsWith("N") || v.endsWith("S") || v.endsWith("O")) {
                    hemisferio = " " + v.slice(-1);
                    v = v.slice(0, -1);
                }

                // Aplica máscara progressiva
                if (v.length > 2)
                    v = v.slice(0, 2) + "°" + v.slice(2);

                if (v.length > 5)
                    v = v.slice(0, 5) + "'" + v.slice(5);

                if (v.length > 8)
                    v = v.slice(0, 8) + "." + v.slice(8);

                if (v.length > 12)
                    v = v.slice(0, 12) + "\"" + hemisferio;

                input.value = v;
            });

        }

        document.querySelectorAll(".coord-mask").forEach(aplicarMascaraCoordenada);
    });
    
    </script>

    <script>
    /* ================= CONVERSÃO FINAL NO SUBMIT ================= */
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function () {

            form.querySelectorAll('.utm-norte, .utm-este, #distancia_ver, #edit_distancia_ver')
                .forEach(input => {
                    if (input.value && input.inputmask) {
                        input.value = input.inputmask.getNumber();
                    }
                });

        });
    });
    </script>


</body>
</html>